import { TsconfigPathsPlugin } from '@esbuild-plugins/tsconfig-paths';
import esbuild from 'esbuild';
import path from 'node:path';
import { Lithia, Route } from 'lithia/types';
import { getOutputPath } from '../_utils';
import { ready, wait } from '../log';
import { scanServerRoutes } from '../scan';
import { printRoutesOverview } from './build';
import { createRoutesManifest } from '../server';

/**
 * Builds the production server entry point.
 * @param {Lithia} lithia - The Lithia instance containing app configuration.
 * @returns {Promise<void>}
 */
async function buildServerEntryPoint(lithia: Lithia): Promise<void> {
  const entryPoint = path.join(import.meta.dirname, '..', 'server.js');
  const outputPath = path.resolve(process.cwd(), lithia.options.outputDir);

  await esbuild.build({
    entryPoints: [entryPoint],
    bundle: true,
    outdir: outputPath,
    platform: 'node',
    format: 'esm',
    packages: 'external',
    sourcemap: true,
    minify: true,
    keepNames: true,
    banner: {
      js: generateServerBanner(),
    },
  });
}

/**
 * Builds individual route files for production.
 * @param {Lithia} lithia - The Lithia instance containing app configuration.
 * @param {Route[]} routes - An array of route objects to be built.
 * @returns {Promise<void>}
 */
async function buildRouteFiles(lithia: Lithia, routes: Route[]): Promise<void> {
  await Promise.all(
    routes.map(async (route) => {
      const outputDir = path.dirname(getOutputPath(lithia, route.filePath));

      await esbuild.build({
        entryPoints: [route.filePath],
        bundle: true,
        outdir: outputDir,
        platform: 'node',
        format: 'esm',
        packages: 'external',
        sourcemap: true,
        minify: true,
        keepNames: true,
        plugins: [
          TsconfigPathsPlugin({
            tsconfig: path.join(process.cwd(), 'tsconfig.json'),
          }),
        ],
        banner: {
          js: generateRouteBanner(route),
        },
      });
    }),
  );
}

/**
 * Generates a banner comment for route files.
 * @param {Route} route - The route object containing metadata.
 * @returns {string} - A formatted banner comment.
 */
function generateRouteBanner(route: Route): string {
  return `
/**
 * @PROD
 * 
 * This file was generated by Lithia.
 * Do not edit this file directly.
 * 
 * Learn more at https://lithiajs.com
 * 
 * Route {
 *  env: ${route.env || 'all'}
 *  path: ${route.path}
 *  method: ${route.method || 'all'}
 *  dynamic: ${route.dynamic}
 * }
 * */
`;
}

/**
 * Generates a banner comment for the server entry point.
 * @returns {string} - A formatted banner comment.
 */
function generateServerBanner(): string {
  return `
/**
 * @PROD
 * 
 * This file was generated by Lithia.
 * Do not edit this file directly.
 * 
 * Learn more at https://lithiajs.com
 * 
 * */`;
}

/**
 * Builds the entire Lithia app for production.
 * @param {Lithia} lithia - The Lithia instance containing app configuration.
 * @returns {Promise<void>}
 */
export async function buildProd(lithia: Lithia): Promise<void> {
  try {
    wait('Building your Lithia app for production...');

    // Step 1: Scan server routes
    const routes = await scanServerRoutes(lithia);

    // Step 2: Build server entry point and route files in parallel
    await Promise.all([
      buildServerEntryPoint(lithia),
      buildRouteFiles(lithia, routes),
    ]);

    // Step 3: Create the routes manifest
    await createRoutesManifest(lithia, routes);

    // Step 4: Print routes overview
    printRoutesOverview(routes);

    // Success message
    ready(`${routes.length} routes have been built successfully!`);
  } catch (error) {
    console.error('Error during production build:', error);
    process.exit(1);
  }
}
